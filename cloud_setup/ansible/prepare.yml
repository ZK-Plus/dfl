---
- name: prepare
  hosts: cloud_vms
  become: yes
  vars:
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
    env_files:
      vm1: "./config/env_0.txt"
      vm2: "./config/env_1.txt"
      vm3: "./config/env_2.txt"
      vm4: "./config/env_3.txt"
  tasks:
    - name: Run apt-get update
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600 # Optional: cache valid for 1 hour to avoid redundant updates

    # - name: Run apt-get upgrade
    #   ansible.builtin.apt:
    #     upgrade: dist
    #     update_cache: yes

    - name: Install ZeroMQ library
      ansible.builtin.apt:
        name: libzmq3-dev
        state: present
        update_cache: yes

    - name: Install build-essential
      ansible.builtin.apt:
        name: build-essential
        state: present
        update_cache: yes

    # - name: Cloning the snpguest repo
    #   ansible.builtin.git:
    #     repo: https://github.com/virtee/snpguest.git
    #     dest: "/home/johann/snpguest"

    # - name: Execute rustup installation script
    #   ansible.builtin.shell:
    #     cmd: "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y"
    #   args:
    #     creates: "{{ ansible_env.HOME }}/.cargo/bin/rustup"

    # - name: Execute cargo build command
    #   ansible.builtin.shell:
    #     cmd: "source $HOME/.cargo/env && cargo build -r"
    #     chdir: "/home/johann/snpguest"
    #     executable: /bin/bash

    - name: Install NVM and Node.js
      ansible.builtin.shell:
        cmd: >
          curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash &&
          export NVM_DIR="$HOME/.nvm" &&
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" &&
          [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
          nvm install 20
        executable: /bin/bash
        #creates: "$HOME/.nvm"

    - name: Copy node server
      ansible.builtin.synchronize:
        src: "../../node_server/"
        dest: "/home/johann/node_server"
        recursive: yes

    - name: Copy local txt file to .env file on VM
      ansible.builtin.copy:
        src: "{{ lookup('vars', 'env_files')[inventory_hostname] }}"
        dest: "/home/johann/node_server/.env"

  
